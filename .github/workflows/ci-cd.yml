name: CI-CD

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      
      - name: Setup DVC
        uses: iterative/setup-dvc@v1

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.10.6

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install black flake8 pytest

      - name: Lint code
        run: |
          black --check src tests
          flake8 src tests --max-line-length=110 --extend-ignore=E203,W503,E402,F401

      - name: Run tests
        run: pytest tests/ -v --tb=short
        
      - name: Setup Great Expectations
        run: |
          printf "Y\nY" | great_expectations init --no-usage-stats

      - name: Validate data with Great Expectations
        run: |
          python -c "
          from src.data.validation import create_expectation_suite, validate_data
          import pandas as pd
          
          create_expectation_suite()
          
          # ТЕСТ: Исходные данные до обработки
          raw_data = pd.DataFrame({
            'ID': [1, 2],
            'LIMIT_BAL': [100000.0, 200000.0],
            'SEX': [1, 2],
            'EDUCATION': [1, 2],
            'MARRIAGE': [1, 1],
            'AGE': [25, 35],
            'PAY_0': [0, 1],
            'PAY_2': [0, 1],
            'PAY_3': [0, 1],
            'PAY_4': [0, 1],
            'PAY_5': [0, 1],
            'PAY_6': [0, 1],
            'BILL_AMT1': [1000.0, 2000.0],
            'BILL_AMT2': [1000.0, 2000.0],
            'BILL_AMT3': [1000.0, 2000.0],
            'BILL_AMT4': [1000.0, 2000.0],
            'BILL_AMT5': [1000.0, 2000.0],
            'BILL_AMT6': [1000.0, 2000.0],
            'PAY_AMT1': [1000.0, 2000.0],
            'PAY_AMT2': [1000.0, 2000.0],
            'PAY_AMT3': [1000.0, 2000.0],
            'PAY_AMT4': [1000.0, 2000.0],
            'PAY_AMT5': [1000.0, 2000.0],
            'PAY_AMT6': [1000.0, 2000.0],
            'default.payment.next.month': [0, 1]
          })
          validate_data(raw_data)
          print('Raw data validation passed')
          "

      - name: Test model training
        run: |
          python -c "
          import runpy
          module = runpy.run_path('src/models/pipeline.py')
          pipeline = module['create_pipeline']()
          print('Pipeline created successfully')
          print(f'Pipeline steps: {pipeline.named_steps}')
          "